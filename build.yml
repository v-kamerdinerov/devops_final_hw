---
- name: Build stage
  hosts: build
  remote_user: ubuntu
  become: yes
  become_user: root
  tasks:
    - name: Install packages for build app
      apt: name={{ item }} update_cache=yes state=present
      with_items:
        - docker.io
        - default-jdk
        - git
        - maven

    - name: Log into DockerHub
      docker_login:
        username: $DOCKER_USER
        password: $DOCKER_PASS

    - name: Clone git repo
      git:
        repo: "https://github.com/v-kamerdinerov/boxfuse.git"
        dest: "/work"
        version: master

    - name: Build java app
      command: mvn clean package
      args:
        chdir: "/work"

    - name: Build and push docker image
      docker_image:
        source: build
        build:
          path: /work/Dockerfile
        name: anakin174/boxfuse-exam
        tag: latest
        target: prod
        push: yes
