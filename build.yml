---
- name: Build stage
  hosts: build
  remote_user: ubuntu
  become: yes
  become_user: root
  tasks:
    - name: Ensure is build software is present
      apt:
        name: "{{ packages }}"
        state: present
      vars:
        packages:
          - python
          - docker.io
          - maven

    - name: Login on dockerhub
      command: echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

    - name: Clone git repo
      git:
        repo: "https://github.com/v-kamerdinerov/boxfuse.git"
        dest: "/work"
        version: master

    - name: Build java app
      command: mvn clean package
      args:
        chdir: "/work"

    - name: Build and push docker image
      docker_image:
        build:
          path: /work
        name: anakin174/boxfuse-exam
        push: yes
        tag: latest
        source: build